<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.3/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

</head>

<body class="bg-light p-4">
    <div class="container bg-white p-4 shadow rounded">
        <h2 class="mb-4 text-center">Bill Management</h2>

        <div class="mb-4 p-3 bg-light border rounded">
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label"><strong>Enter Total Billed Amount:</strong></label>
                    <input type="number" id="manualBilled" class="form-control mb-2">
                </div>
                <div class="col-md-6">
                    <label class="form-label"><strong>Enter Total Received Amount:</strong></label>
                    <input type="number" id="manualReceived" class="form-control mb-2">
                </div>
            </div>
            <div class="row mt-3 text-center">
                <div class="col-12 d-flex gap-2">
                    <button onclick="manualCalculation()" class="btn btn-primary flex-grow-1">Calculate</button>
                    <button onclick="clearFields()" class="btn btn-secondary flex-grow-1">Clear</button>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-6"><strong>Deducted Amount:</strong> ₹<span id="manualDeduction">0.00</span></div>
                <div class="col-md-6"><strong>Deduction Percentage & Type:</strong> <span
                        id="manualDeductionPercentage">0.00%</span></div>
            </div>
        </div>

        <table class="table table-bordered" id="billTable">
            <thead class="table-light text-center">
                <tr>
                    <th>Bill Number</th>
                    <th>Date</th>
                    <th>Bill Amount (₹)</th>
                    <th>Deduction (₹)</th>
                    <th>Deduction Percentage & Type</th>
                    <th>Amount Received (₹)</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div class="text-center my-3 d-flex gap-2 justify-content-center">
            <button onclick="addRow()" class="btn btn-primary">+ Add Bill</button>
            <button onclick="exportToExcel()" class="btn btn-success">Export to Excel</button>
            <button onclick="exportToPDF()" class="btn btn-danger">Export to PDF</button>
            <button onclick="window.print()" class="btn btn-secondary">Print</button>
        </div>

        <div class="mt-4 p-3 bg-light border rounded text-center">
            <div class="row">
                <div class="col-md-4"><strong>Total Billed Amount:</strong> ₹<span id="totalBilled">0.00</span></div>
                <div class="col-md-4"><strong>Total Deducted:</strong> ₹<span id="totalDeducted">0.00</span></div>
                <div class="col-md-4"><strong>Total Amount Received:</strong> ₹<span id="totalReceived">0.00</span>
                </div>
            </div>
            <div class="mt-2"><strong>Total Deduction Percentage & Type:</strong> <span
                    id="totalDeductionPercentage">0.00%</span></div>
        </div>
    </div>

    <script>
        function manualCalculation() {
            let billed = parseFloat(document.getElementById("manualBilled").value) || 0;
            let received = parseFloat(document.getElementById("manualReceived").value) || 0;
            let percentage = 0;
            let deductionDetails = "";

            if (billed) {
                percentage = billed > 25000 ? 4.24 : 2.24;
                deductionDetails = billed > 25000 ? "2% GST + 2.24% TDS" : "2.24% TDS";
                received = billed - (billed * percentage / 100);
            } else if (received) {
                billed = received / (1 - (2.24 / 100));
                if (billed > 25000) {
                    billed = received / (1 - (4.24 / 100));
                    percentage = 4.24;
                    deductionDetails = "2% GST + 2.24% TDS";
                } else {
                    percentage = 2.24;
                    deductionDetails = "2.24% TDS";
                }
            }

            document.getElementById("manualBilled").value = billed.toFixed(2);
            document.getElementById("manualReceived").value = received.toFixed(2);
            document.getElementById("manualDeduction").innerText = (billed - received).toFixed(2);
            document.getElementById("manualDeductionPercentage").innerText = percentage.toFixed(2) + "% " + deductionDetails;
        }

        function clearFields() {
            document.getElementById("manualBilled").value = "";
            document.getElementById("manualReceived").value = "";
            document.getElementById("manualDeduction").innerText = "0.00";
            document.getElementById("manualDeductionPercentage").innerText = "0.00%";
        }

       function calculateTotals() {
            let totalBilled = 0;
            let totalDeducted = 0;
            let totalReceived = 0;
            let totalPercentage = 0;
            let totalDeductionDetails = "";

            document.querySelectorAll("#billTable tbody tr").forEach(row => {
                let billAmount = parseFloat(row.querySelector(".billAmount").value) || 0;
                let receivedAmount = parseFloat(row.querySelector(".receivedAmount").value) || 0;
                let deductionAmount = billAmount - receivedAmount;

                totalBilled += billAmount;
                totalDeducted += deductionAmount;
                totalReceived += receivedAmount;
            });

            if (totalBilled > 0) {
                totalPercentage = (totalDeducted / totalBilled) * 100;
                totalDeductionDetails = totalPercentage > 2.24 ? "2% GST + 2.24% TDS" : "2.24% TDS";
            } else {
                totalPercentage = 0;
                totalDeductionDetails = "2.24% TDS";
            }

            document.getElementById("totalBilled").innerText = totalBilled;
            document.getElementById("totalDeducted").innerText = totalDeducted.toFixed(2);
            document.getElementById("totalReceived").innerText = totalReceived;
            document.getElementById("totalDeductionPercentage").innerText = totalPercentage.toFixed(2) + "% " + totalDeductionDetails;
        }
       function addRow() {
            let table = document.getElementById("billTable").getElementsByTagName('tbody')[0];
            let newRow = table.insertRow();
            newRow.innerHTML = `
            <td><input type="text" class="form-control"></td>
            <td><input type="date" class="form-control"></td>
            <td><input type="number" class="form-control billAmount"  onblur="updateRow(this)"></td>
            <td class="deduction">0.00</td>
            <td class="deductionPercentage">0.00%</td>
            <td><input type="number" class="form-control receivedAmount" onblur="updateRow(this)"></td>
            <td><button class="btn btn-danger btn-sm" onclick="deleteRow(this)">Delete</button></td>
        `;
            calculateTotals();
        }

        function updateRow(input) {
                let row = input.parentNode.parentNode;
                let billAmount = parseFloat(row.querySelector(".billAmount").value) || 0;
                let receivedAmount = parseFloat(row.querySelector(".receivedAmount").value) || 0;
                let percentage = 0;
                let deductionDetails = "";

                if (billAmount) {
                    percentage = billAmount > 25000 ? 4.24 : 2.24;
                    deductionDetails = billAmount > 25000 ? "2% GST + 2.24% TDS" : "2.24% TDS";
                    receivedAmount = billAmount - (billAmount * percentage / 100);
                } else if (receivedAmount) {
                    billAmount = receivedAmount / (1 - (2.24 / 100));
                    if (billAmount > 25000) {
                        billAmount = receivedAmount / (1 - (4.24 / 100));
                        percentage = 4.24;
                        deductionDetails = "2% GST + 2.24% TDS";
                    } else {
                        percentage = 2.24;
                        deductionDetails = "2.24% TDS";
                    }
                }

                let deductionAmount = billAmount - receivedAmount;
                row.querySelector(".deduction").innerText = deductionAmount.toFixed(2);
                row.querySelector(".deductionPercentage").innerText = percentage.toFixed(2) + "% " + deductionDetails;

                // Update the input fields with calculated values
                row.querySelector(".billAmount").value = billAmount.toFixed(2);
                row.querySelector(".receivedAmount").value = receivedAmount.toFixed(2);

                // Calculate totals
                calculateTotals();
            }


       function deleteRow(button) {
            let row = button.parentNode.parentNode;
            row.parentNode.removeChild(row);
            calculateTotals();
        }
        function exportToExcel() {
            let table = document.getElementById("billTable");
            let wb = XLSX.utils.table_to_book(table, { sheet: "Sheet1" });
            XLSX.writeFile(wb, "Bill_Management.xlsx");
        }

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            let doc = new jsPDF();
            doc.text("Bill Management Data", 10, 10);

            // Use autoTable plugin
            doc.autoTable({
                html: "#billTable",
                startY: 20,
                theme: "grid"
            });

            doc.save("Bill_Management.pdf");
        }
    </script>
</body>

</html>